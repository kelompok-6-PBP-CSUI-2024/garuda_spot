{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="bg-white w-full min-h-screen mt-14 mb-16">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">


    <article id="product-content" 
           class="overflow-hidden">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8 p-6 sm:p-8 items-start">
            
            <div id="image-container" class="w-full flex justify-center items-center overflow-hidden rounded-md border border-red-100 bg-gray-100">
                <div class="w-full aspect-square overflow-hidden">
                    {% if merch.thumbnail %}
                        <img id="d-thumb" 
                             src="{{ merch.thumbnail }}" 
                             alt="{{ merch.name }}" 
                             class="w-full h-full object-cover transition-transform duration-300 ease-out transform hover:scale-110">
                    {% else %}
                        <div class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-500">No Image</div>
                    {% endif %}
                </div>
            </div>

            <div class="space-y-4 flex flex-col min-w-0">
                
                <p id="d-vendor" class="text-xl font-bold text-gray-700 leading-tight mb-1 uppercase">
                    {{ merch.vendor }}
                </p>
                <h1 id="d-name" class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight break-words">
                    {{ merch.name }}
                </h1>

                <p class="text-4xl font-extrabold text-red-700 my-2">
                    Rp <span id="d-price">{{ merch.price|intcomma }}</span>
                </p>

                <div class="flex flex-wrap items-center text-sm text-gray-600 gap-8 border-t border-b border-gray-200 py-3">
                    <span class="font-medium">
                        Stock: <span id="d-stock">{{ merch.stock|default:"-" }}</span>
                    </span>
                    <span class="font-medium capitalize">
                        Category: <span id="d-category">{{ merch.category }}</span>
                    </span>
                </div>

                {% if merch.description %}
                <div id="d-desc" class="text-gray-800 text-sm sm:text-md leading-none pt-2 overflow-hidden">
                    {{ merch.description|linebreaksbr}}
                </div>
                {% endif %}

                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                    {% if merch.link %}
                    <a href="{{ merch.link }}" target="_blank" rel="noopener noreferrer"
                       class="bg-red-600 text-white w-full py-3 rounded-md font-medium hover:bg-red-700 transition-colors text-center inline-flex items-center justify-center">
                      Shop Now (Visit Vendor)
                    </a>
                    {% endif %}

                    {% if user.is_authenticated and user.is_admin %}
                    <div class="flex gap-4 w-full sm:w-auto">
                        <button type="button"
                                id="editBtn"
                                class="bg-gray-200 text-gray-800 w-full sm:w-auto px-4 py-3 rounded-md font-medium hover:bg-gray-300 transition-colors"
                                data-url="{% url 'merch:update_merch' merch.id %}"
                                data-id="{{ merch.id }}"
                                data-name="{{ merch.name|escape }}"
                                data-vendor="{{ merch.vendor|escape }}"
                                data-price="{{ merch.price }}"
                                data-stock="{{ merch.stock }}"
                                data-thumbnail="{{ merch.thumbnail|default:''|escape }}"
                                data-category="{{ merch.category }}"
                                data-link="{{ merch.link|default:''|escape }}"
                                data-description="{{ merch.description|default:''|escape }}">
                          Edit
                        </button>

                        <button type="button"
                                id="deleteBtn"
                                class="bg-red-500 text-white w-full sm:w-auto px-4 py-3 rounded-md font-medium hover:bg-red-600 transition-colors">
                          Delete
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                {% if not merch.link and not user.is_admin %}
                    <div class="text-gray-500 text-sm italic pt-4">Tautan produk tidak tersedia.</div>
                {% endif %}
            </div>
        </div>
    </article>

  </div>
</div>

{% if user.is_authenticated and user.is_admin %}
<div id="editModal" class="hidden fixed inset-0 z-50 w-full h-full flex items-center justify-center">
  <div class="absolute inset-0 bg-black/60" onclick="EditDetail.hide()"></div>

  <div class="relative bg-white w-[92%] max-w-xl rounded-2xl border border-gray-200 shadow-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-2xl font-bold text-gray-900">Edit Merch</h3>
      <button type="button" class="px-2 py-1 rounded hover:bg-gray-100" onclick="EditDetail.hide()">âœ•</button>
    </div>

    <form id="editForm" class="space-y-4" novalidate>
      <input type="hidden" name="id" id="edit-id">

      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input name="name" id="edit-name" required class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Vendor</label>
        <input name="vendor" id="edit-vendor" required class="w-full border rounded-lg px-3 py-2">
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Price</label>
          <input type="number" min="0" name="price" id="edit-price" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Stock</label>
          <input type="number" min="0" name="stock" id="edit-stock" class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Thumbnail URL</label>
        <input name="thumbnail" id="edit-thumbnail" class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select name="category" id="edit-category" class="w-full border rounded-lg px-3 py-2">
          <option value="jersey">Jersey</option>
          <option value="jacket">Jacket</option>
          <option value="hoodie">Hoodie</option>
          <option value="cap">Cap</option>
          <option value="scarf">Scarf</option>
          <option value="keychain">Keychain</option>
          <option value="others">Others</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Product Link</label>
        <input name="link" id="edit-link" class="w-full border rounded-lg px-3 py-2">
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Description</label>
        <textarea name="description" id="edit-description" rows="4" class="w-full border rounded-lg px-3 py-2"></textarea>
      </div>

      <p id="editError" class="hidden text-sm text-red-600"></p>

      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button" class="px-4 py-2 rounded border border-gray-300" onclick="EditDetail.hide()">Cancel</button>
        <button id="editSubmit" type="submit" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
function cap(s){ return (s||'').replace(/^./, c=>c.toUpperCase()); }
function formatRupiah(n){ try{ return new Intl.NumberFormat('id-ID').format(Number(n||0)); }catch{ return String(n); } }
async function postForm(url, fd){
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With':'XMLHttpRequest' },
    body: fd
  });
  const ct = res.headers.get('content-type')||'';
  if (!res.ok) throw new Error(ct.includes('application/json') ? (await res.json()).detail || 'Request failed' : await res.text());
  return ct.includes('application/json') ? res.json() : res.text();
}

/* ========= Delete ========= */
document.getElementById('deleteBtn')?.addEventListener('click', async ()=>{
  if (!confirm('Delete this merch?')) return;
  try{
    await postForm("{% url 'merch:delete_merch' merch.id %}", new FormData());
    window.location.href = "{% url 'merch:show_merch' %}";
  }catch(err){
    alert('Gagal menghapus item.');
    console.error(err);
  }
});

/* ========= Edit ========= */
const EditDetail = (function(){
  const modal = document.getElementById('editModal');
  const form  = document.getElementById('editForm');
  const errEl = document.getElementById('editError');
  const submitBtn = document.getElementById('editSubmit');
  const editBtn = document.getElementById('editBtn');

  const fields = {
    id: document.getElementById('edit-id'),
    name: document.getElementById('edit-name'),
    vendor: document.getElementById('edit-vendor'),
    price: document.getElementById('edit-price'),
    stock: document.getElementById('edit-stock'),
    thumbnail: document.getElementById('edit-thumbnail'),
    category: document.getElementById('edit-category'),
    link: document.getElementById('edit-link'),
    description: document.getElementById('edit-description'),
  };

  function show(){
    // prefill dari dataset tombol edit
    fields.id.value          = editBtn.dataset.id || '';
    fields.name.value        = editBtn.dataset.name || '';
    fields.vendor.value      = editBtn.dataset.vendor || '';
    fields.price.value       = editBtn.dataset.price || '';
    fields.stock.value       = editBtn.dataset.stock || '';
    fields.thumbnail.value   = editBtn.dataset.thumbnail || '';
    fields.category.value    = (editBtn.dataset.category || 'others').toLowerCase();
    fields.link.value        = editBtn.dataset.link || '';
    fields.description.value = editBtn.dataset.description || '';

    errEl.classList.add('hidden'); errEl.textContent='';
    modal.classList.remove('hidden');
    setTimeout(()=>fields.name.focus(),0);
  }
  function hide(){ modal.classList.add('hidden'); }

  editBtn?.addEventListener('click', show);

  form?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
    errEl.classList.add('hidden'); errEl.textContent='';

    try{
      const data = await postForm(editBtn.dataset.url, new FormData(form));

      // Update tampilan detail
      document.getElementById('d-name')  .textContent = data.name;
      document.getElementById('d-vendor').textContent = data.vendor;
      document.getElementById('d-category').textContent = cap(data.category);
      document.getElementById('d-price').textContent   = formatRupiah(data.price);
      document.getElementById('d-stock').textContent   = data.stock ?? '-';
      
      const linkEl = document.querySelector('a[href*="Visit vendor"]');
      if (linkEl) linkEl.href = data.link || '#';

      if (data.description !== undefined){
        const descEl = document.getElementById('d-desc');
        if (descEl) descEl.textContent = data.description || '';
      }
      if (data.thumbnail){
        const img = document.getElementById('d-thumb');
        if (img) img.src = data.thumbnail;
      }

      // Sinkronkan dataset tombol edit untuk edit berikutnya
      editBtn.dataset.name = data.name || '';
      editBtn.dataset.vendor = data.vendor || '';
      editBtn.dataset.price = data.price ?? '';
      editBtn.dataset.stock = data.stock ?? '';
      editBtn.dataset.thumbnail = data.thumbnail || '';
      editBtn.dataset.category = data.category || 'others';
      editBtn.dataset.link = data.link || '';
      editBtn.dataset.description = data.description || '';

      hide();
    }catch(err){
      errEl.textContent = String(err.message||err).slice(0,300);
      errEl.classList.remove('hidden');
    }finally{
      submitBtn.disabled = false; submitBtn.textContent = 'Save Changes';
    }
  });

  // esc
  document.addEventListener('keydown', ev=>{ if(ev.key==='Escape' && !modal.classList.contains('hidden')) hide(); });
  return { show, hide };
})();
</script>
{% endblock content %}