{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="md:mt-20 md:mx-36 bg-white">

    <h2 class="pt-8 pb-4 text-6xl font-extrabold text-center">Schedule</h2>

    <div class="flex justify-between mb-8 ml-8 mt-12">
        <form method="get" id="categoryFilterForm">
            <select name="category" onchange="filterAndDisplayMatches()"
                    class="border-b-2 border-red-600 px-8 py-2 text-sm cursor-pointer">
                <option value="">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
            </select>
        </form>
{% if request.user.is_authenticated and request.user.is_admin %}
<div class="text-end mb-3 mr-8">
    <button type="button" id="open-fixture-modal-btn" class="border-b-2 border-red-600 px-8 py-2 text-sm cursor-pointer">+ Fixtures</button>
</div>
{% endif %}
    </div>

    <div id="loading" class="bg-white py-12 text-center">
      <svg class="animate-spin h-8 w-8 text-red-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading matches...</p>
    </div>

    <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative m-4" role="alert">
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline" id="error-message">Failed to load matches.</span>
    </div>

    <div id="grid" class="hidden"></div>

    <div id="empty" class="bg-white py-12 text-center hidden">
        <h3 class="text-lg font-medium text-gray-900 mb-2">No matches found</h3>
    </div>

</div>

{% include 'create_match_modal.html' %}
{% include 'edit_match_modal.html' %} 

<div id="toast-component" class="fixed bottom-5 right-5 w-full max-w-xs p-4 rounded-lg shadow-lg transition-all duration-300 opacity-0 translate-y-64" style="z-index: 100;">
    <h3 id="toast-title" class="font-semibold"></h3>
    <p id="toast-message" class="text-sm"></p>
</div>

<script src="{% static 'js/toast.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script>
// --- 1. Konfigurasi & Variabel Global ---
    const MATCH_API_ENDPOINT = "{% url 'schedule:show_json' %}";
    const ADD_MATCH_ENDPOINT = "{% url 'schedule:add_match_ajax' %}";
    
    // KOREKSI UTAMA: Gunakan UUID placeholder valid langsung di URL tag
    const UUID_PLACEHOLDER_FOR_URL = '00000000-0000-0000-0000-000000000000';
    
    // Hasilnya: "/schedule/update-ajax/00000000-0000-0000-0000-000000000000/"
    // Kita passing string UUID valid, BUKAN variabel JS
    const UPDATE_MATCH_FULL_URL = "{% url 'schedule:update_match_ajax' match_id='00000000-0000-0000-0000-000000000000' %}";
    const DELETE_MATCH_FULL_URL = "{% url 'schedule:delete_match_ajax' match_id='00000000-0000-0000-0000-000000000000' %}";

    // Base URL yang akan digunakan di JS, hasilnya: "/schedule/update-ajax/"
    const UPDATE_MATCH_BASE_URL = UPDATE_MATCH_FULL_URL.replace(UUID_PLACEHOLDER_FOR_URL, '').replace(/\/$/, "");
    const DELETE_MATCH_BASE_URL = DELETE_MATCH_FULL_URL.replace(UUID_PLACEHOLDER_FOR_URL, '').replace(/\/$/, "");
    let allMatchesData = [];

    // --- 2. Elemen DOM ---
    const loadingSpinner = document.getElementById('loading');
    const errorDisplay = document.getElementById('error');
    const errorMessage = document.getElementById('error-message');
    const emptyStateDisplay = document.getElementById('empty');
    const matchesGridContainer = document.getElementById('grid');
    const categoryFilterSelect = document.getElementById('categoryFilterForm').querySelector('select');
    
    // Elemen Modal Create
    const modal = document.getElementById('fixture-modal');
    const modalContent = document.getElementById('fixture-modal-content');
    const openBtn = document.getElementById('open-fixture-modal-btn');
    const openBtnEmpty = document.getElementById('open-fixture-modal-btn-empty');
    const closeBtn = document.getElementById('close-fixture-modal-btn');
    const cancelBtn = document.getElementById('cancel-fixture-btn');
    const form = document.getElementById('create-match-form');
    const submitBtn = document.getElementById('submit-fixture-btn');
    const formError = document.getElementById('form-error');

    // Elemen Modal Edit
    const editModal = document.getElementById('edit-fixture-modal');
    const editModalContent = document.getElementById('edit-fixture-modal-content');
    const closeEditBtn = document.getElementById('close-edit-modal-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const editForm = document.getElementById('edit-match-form');
    const editSubmitBtn = document.getElementById('submit-edit-btn');
    const editFormError = document.getElementById('edit-form-error');


    // --- 3. Utility Functions ---
    function setVis(el, show) { if (el) el.classList.toggle('hidden', !show); }
    function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
        setVis(loadingSpinner, showLoading);
        setVis(errorDisplay, showError);
        setVis(emptyStateDisplay, showEmpty);
        setVis(matchesGridContainer, showGrid);
        if (matchesGridContainer) {
            matchesGridContainer.style.display = showGrid ? '' : 'none';
        }
    }
    function getCookie(name) {
        const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
        return v ? decodeURIComponent(v.split('=')[1]) : null;
    }

    // --- 4. Render Card Match (Diperbarui untuk tombol Admin) ---
    function buildMatchCardElement(match) {
        const anchor = document.createElement('a');
        const linkDetail = `{% url 'schedule:show_match' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', match.id);
        anchor.href = linkDetail;

        // Sanitize data
        const location = DOMPurify.sanitize(match.location);
        const category = DOMPurify.sanitize(match.category);
        const categoryImg = DOMPurify.sanitize(match.category_image_url);
        const homeCode = DOMPurify.sanitize(match.home_code || '');
        const homeTeam = DOMPurify.sanitize(match.home_team);
        const awayCode = DOMPurify.sanitize(match.away_code || '');
        const awayTeam = DOMPurify.sanitize(match.away_team);

        // Format Date
        const matchDate = new Date(match.match_date);
        const dateOptions = { weekday: 'long', day: '2-digit', month: 'short', year: 'numeric' };
        const formattedDate = matchDate.toLocaleDateString('en-US', dateOptions).replace(',', '');

        // Conditional HTML
        const categoryImgHtml = (categoryImg) ? `<img src="${categoryImg}" class="w-8 mb-2 inline-block ml-2" alt="">` : '';
        const scoreHtml = (match.home_score !== null && match.away_score !== null) ? `${match.home_score} - ${match.away_score}` : 'vs';

        // Admin Controls
        let adminControlsHtml = '';
        {% if request.user.is_authenticated and request.user.is_admin %}

        adminControlsHtml = `
            <div class="flex space-x-2 mt-2" onclick="event.preventDefault(); event.stopPropagation();">
                <button type="button" data-match-id="${match.id}" class="edit-match-btn text-xs font-semibold border border-red-600 px-2 py-1 hover:bg-gray-200">Edit</button>
                <button type="button" data-match-id="${match.id}" data-match-teams="${homeTeam} vs ${awayTeam}" class="delete-match-btn text-xs text-red-600 font-semibold border border-red-600 px-2 py-1 hover:bg-gray-200">Delete</button>
            </div>
        `;
        {% endif %}

        // Build HTML
        anchor.innerHTML = `
            <div class="flex flex-col bg-white border-b border-t border-red-600 items-center hover:bg-white hover:shadow-lg hover:-translate-y-1 py-4 px-2 transition-all duration-300 ease-in-out">
                <div class="flex flex-row justify-between items-start gap-3 w-full max-w-12xl px-4">
                    <div class="md:py-4 py-0"> 
                        <p class="text-md">${formattedDate}</p> 
                        <p class="font-light text-md">${location}</p> 
                    </div>
                    
                    <div class="flex flex-row justify-center items-start gap-1"> <span class="font text-red-700 text-md block">${category}</span> ${categoryImgHtml} </div>
                </div>
                <div class="flex flex-row justify-between items-start gap-3 w-full max-w-12xl px-4 md:hidden py-2">
                    <span class="font-semibold uppercase text-xl text-right truncate">${homeTeam}</span>
                    <span class="font-semibold uppercase text-xl text-left truncate">${awayTeam}</span>
                </div>
                <div class="relative flex items-center justify-between w-full max-w-4xl my-2 px-4 py-4">
                  <div class="mr-2 flex flex-row-reverse items-center gap-3 flex-1 min-w-0">
                    <img src="https://flagcdn.com/w160/${homeCode.toLowerCase()}.png" onerror="this.style.display='none'; this.onerror=null;" class=" h-10 border border-gray-400 object-cover shrink-0">
                    <span class="hidden md:block font-semibold uppercase text-xl text-right truncate">${homeTeam}</span>
                  </div>
                  <div class="w-32 flex justify-center"> <h2 class="text-xl font-semibold px-6 py-2 bg-red-100/80 rounded-md text-center">${scoreHtml}</h2> </div>
                  <div class="ml-2 flex flex-row items-center gap-3 flex-1 min-w-0">
                    <img src="https://flagcdn.com/w160/${awayCode.toLowerCase()}.png" onerror="this.style.display='none'; this.onerror=null;" class="h-10 border border-gray-400 object-cover shrink-0">
                    <span class="hidden md:block font-semibold uppercase text-xl text-left truncate">${awayTeam}</span>
                  </div>
                </div>
                ${adminControlsHtml} 
            </div>`;
        return anchor;
    }

    function renderAllMatches(matches) {
        if (!matchesGridContainer) return;
        matchesGridContainer.innerHTML = '';
        const monthGroups = {};
        matches.forEach(match => {
            const date = new Date(match.match_date);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthGroups[monthKey]) { monthGroups[monthKey] = { month_date: new Date(date.getFullYear(), date.getMonth(), 1), matches: [] }; }
            monthGroups[monthKey].matches.push(match);
        });
        const sortedGroups = Object.values(monthGroups).sort((a, b) => b.month_date - a.month_date); 
        sortedGroups.forEach(group => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'my-4 mx-4 bg-white py-4 px-4';
            const monthTitle = group.month_date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const titleElement = document.createElement('h3');
            titleElement.className = 'text-3xl font-semibold mt-6 mb-10 border-l-4 border-red-700 pl-4';
            titleElement.textContent = monthTitle;
            const matchesContainer = document.createElement('div');
            matchesContainer.className = 'flex flex-col';
            group.matches.sort((a, b) => new Date(b.match_date) - new Date(a.match_date));
            group.matches.forEach(match => { matchesContainer.appendChild(buildMatchCardElement(match)); });
            groupContainer.appendChild(titleElement);
            groupContainer.appendChild(matchesContainer);
            matchesGridContainer.appendChild(groupContainer);
        });

        // Pasang Event Listeners untuk tombol Admin setelah rendering
        attachAdminButtonListeners(); 
    }

    function filterAndDisplayMatches() {
        const selectedCategory = categoryFilterSelect ? categoryFilterSelect.value : '';
        const filteredMatches = selectedCategory ? allMatchesData.filter(match => match.category === selectedCategory) : allMatchesData;

        if (filteredMatches.length === 0) {
            displayPageSection({ showEmpty: true, showGrid: false, showLoading: false, showError: false });
        } else {
            renderAllMatches(filteredMatches);
            displayPageSection({ showGrid: true, showEmpty: false, showLoading: false, showError: false });
        }
    }

    // --- 5. Fetch Data (sama) ---
    async function fetchMatchesFromServer() {
        try {
            if (!matchesGridContainer || matchesGridContainer.classList.contains('hidden')) {
                 displayPageSection({ showLoading: true, showGrid: false, showEmpty: false, showError: false });
             }
            const apiUrl = `${MATCH_API_ENDPOINT}?_=${Date.now()}`;
            const response = await fetch(apiUrl, {
                headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Failed to fetch: ${response.statusText}`);
            }

            const data = await response.json();
            allMatchesData = data || [];
            filterAndDisplayMatches();

        } catch (error) {
            console.error('Error in fetchMatchesFromServer:', error);
            if (errorMessage) errorMessage.textContent = error.message;
            displayPageSection({ showError: true, showLoading: false, showGrid: false, showEmpty: false });
        } finally {
             if (loadingSpinner) loadingSpinner.classList.add('hidden');
         }
    }

    // --- 6. Modal Create Functions (sama) ---
    function showFixtureModal() {
        if (!modal || !modalContent) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setTimeout(() => { modalContent.classList.remove('opacity-0', 'scale-95'); modalContent.classList.add('opacity-100', 'scale-100'); }, 50);
    }
    function hideFixtureModal() {
        if (!modal || !modalContent) return;
        modalContent.classList.remove('opacity-100', 'scale-100'); modalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 150);
    }

    // --- 7. Submit Match (Create - sama) ---
    async function addMatchEntry(form, submitBtn) {
        // ... (Logika sama) ...
        const submitText = submitBtn.querySelector('#submit-text');
        const submitLoading = submitBtn.querySelector('#submit-loading');

        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        submitBtn.disabled = true;
        if (formError) formError.classList.add('hidden');

        try {
            const csrfToken = getCookie('csrftoken');
            if (!csrfToken) { throw new Error("CSRF Token missing. Please refresh the page."); }

            const response = await fetch(ADD_MATCH_ENDPOINT, {
                method: "POST",
                body: new FormData(form),
                headers: { 'X-CSRFToken': csrfToken || '' }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to add match.');
            }

            form.reset();
            hideFixtureModal();
            showToast('Match Added!', 'Fixture has been added successfully.', 'success');
            document.dispatchEvent(new CustomEvent('matchAdded'));

        } catch (error) {
            console.error('Error in addMatchEntry:', error);
            const errorMsg = error.message.includes("INVALID") ? "Error: Pastikan semua field wajib (*) terisi." : `Error: ${error.message}`;
            if (formError) {
                 formError.textContent = errorMsg;
                 formError.classList.remove('hidden');
             }
            showToast('Submission Failed', errorMsg, 'error');
        } finally {
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
            submitBtn.disabled = false;
        }
    }
    
    // --- 8. Modal Edit Functions (sama) ---

    function showEditFixtureModal() {
        if (!editModal || !editModalContent) return;
        editModal.classList.remove('hidden');
        editModal.classList.add('flex');
        setTimeout(() => { editModalContent.classList.remove('opacity-0', 'scale-95'); editModalContent.classList.add('opacity-100', 'scale-100'); }, 50);
    }
    function hideEditFixtureModal() {
        if (!editModal || !editModalContent) return;
        editModalContent.classList.remove('opacity-100', 'scale-100'); editModalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => { 
            editModal.classList.add('hidden'); 
            editModal.classList.remove('flex'); 
            if (editFormError) editFormError.classList.add('hidden');
        }, 150);
    }
    
    function loadMatchDataToForm(matchId) {
        const match = allMatchesData.find(m => m.id === matchId);
        if (!match) { showToast('Error', 'Match data not found.', 'error'); return; }

        // Format date for datetime-local input (YYYY-MM-DDTHH:MM)
        // Match date from API is ISO format (e.g., "2025-10-24T14:00:00Z"), need to convert to local input format
        let matchDateISO = '';
        if (match.match_date) {
            // Check if the timestamp ends with Z (UTC) and strip it if needed to prevent local conversion bias
            const dateStr = match.match_date.endsWith('Z') ? match.match_date.slice(0, -1) : match.match_date;
            
            // Convert to format required by datetime-local input (YYYY-MM-DDTHH:MM)
            const dateObj = new Date(dateStr);
            const yyyy = dateObj.getFullYear();
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const hh = String(dateObj.getHours()).padStart(2, '0');
            const mi = String(dateObj.getMinutes()).padStart(2, '0');
            matchDateISO = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
        }


        // Isi form field
        document.getElementById('edit-match-id').value = match.id;
        document.getElementById('edit-home_team').value = match.home_team || '';
        document.getElementById('edit-away_team').value = match.away_team || '';
        document.getElementById('edit-match_date').value = matchDateISO; // Menggunakan format yang sudah dikonversi
        document.getElementById('edit-location').value = match.location || '';
        document.getElementById('edit-category').value = match.category || '';
        document.getElementById('edit-home_score').value = match.home_score !== null ? match.home_score : '';
        document.getElementById('edit-away_score').value = match.away_score !== null ? match.away_score : '';
        document.getElementById('edit-home_code').value = match.home_code || '';
        document.getElementById('edit-away_code').value = match.away_code || '';
        document.getElementById('edit-lineup').value = match.lineup || '';
        document.getElementById('edit-review').value = match.review || '';
        // ... (Statistik lainnya) ...

        showEditFixtureModal();
    }
    
    // --- 9. AJAX Edit & Delete Functions (DIPERBAIKI penanganan error non-JSON) ---

    async function updateMatchEntry(form, submitBtn, matchId) {
        const submitText = submitBtn.querySelector('#edit-submit-text');
        const submitLoading = submitBtn.querySelector('#edit-submit-loading');
        
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        submitBtn.disabled = true;
        if (editFormError) editFormError.classList.add('hidden');

        let errorMsg = 'Failed to update match due to an unknown error.';

        try {
            const csrfToken = getCookie('csrftoken');
            const endpoint = `${UPDATE_MATCH_BASE_URL}${matchId}/`; // Menggunakan URL yang sudah dikoreksi

            const response = await fetch(endpoint, {
                method: "POST",
                body: new FormData(form),
                headers: { 'X-CSRFToken': csrfToken || '' }
            });

            if (!response.ok) {
                // Mencoba membaca JSON untuk error terperinci
                try {
                    const errorData = await response.json();
                    if (errorData.errors) {
                        const validationMsgs = Object.keys(errorData.errors).map(key => `${key}: ${errorData.errors[key].join(', ')}`);
                        errorMsg = `Validation failed: ${validationMsgs.join(' | ')}`;
                    } else {
                        errorMsg = errorData.detail || `Server error. Status: ${response.status}`;
                    }
                } catch (e) {
                    // Jika respons bukan JSON (misal: HTML login/403)
                    console.error("Non-JSON response received on Update. Status:", response.status);
                    if (response.status === 403) {
                        errorMsg = "You are not authorized. Please log in as admin.";
                    } else {
                        errorMsg = `Server returned an unexpected response. Status: ${response.status}.`;
                    }
                }
                throw new Error(errorMsg);
            }

            // --- SUKSES ---
            hideEditFixtureModal();
            showToast('Match Updated!', 'Fixture has been updated successfully.', 'success');
            document.dispatchEvent(new CustomEvent('matchAdded')); // Trigger refresh

        } catch (error) {
            console.error('Error in updateMatchEntry:', error);
            const finalErrorMsg = error.message;
            if (editFormError) {
                 editFormError.textContent = finalErrorMsg;
                 editFormError.classList.remove('hidden');
             }
            showToast('Update Failed', finalErrorMsg, 'error');
        } finally {
            submitText.classList.remove('hidden');
            submitLoading.classList.add('hidden');
            submitBtn.disabled = false;
        }
    }

    async function deleteMatchEntry(matchId, matchTeams) {
        if (!confirm(`Are you sure you want to delete the match: ${matchTeams}? This action cannot be undone.`)) {
            return;
        }
        
        let errorMsg = 'Deletion failed due to an unknown error.';

        try {
            const csrfToken = getCookie('csrftoken');
            const endpoint = `${DELETE_MATCH_BASE_URL}${matchId}/`; // Menggunakan URL yang sudah dikoreksi

            const response = await fetch(endpoint, {
                method: "POST",
                headers: { 
                    'X-CSRFToken': csrfToken || '',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                // Mencoba membaca JSON untuk error terperinci
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || `Server error. Status: ${response.status}`;
                } catch (e) {
                    // Jika respons bukan JSON (misal: HTML login/403) - INI MEMPERBAIKI KESALAHAN ANDA
                    console.error("Non-JSON response received on Delete. Status:", response.status);
                    if (response.status === 403) {
                        errorMsg = "You are not authorized to delete this match. Please log in as admin.";
                    } else {
                        errorMsg = `Server returned an unexpected response. Status: ${response.status}.`;
                    }
                }
                throw new Error(errorMsg);
            }

            // --- SUKSES ---
            showToast('Match Deleted!', `${matchTeams} has been deleted.`, 'success');
            document.dispatchEvent(new CustomEvent('matchAdded')); // Trigger refresh

        } catch (error) {
            console.error('Error in deleteMatchEntry:', error);
            showToast('Deletion Failed', error.message, 'error');
        }
    }

    function attachAdminButtonListeners() {
        // Edit Buttons
        document.querySelectorAll('.edit-match-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault(); 
                e.stopPropagation(); 
                const matchId = e.currentTarget.dataset.matchId;
                loadMatchDataToForm(matchId);
            });
        });

        // Delete Buttons
        document.querySelectorAll('.delete-match-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault(); 
                e.stopPropagation(); 
                const matchId = e.currentTarget.dataset.matchId;
                const matchTeams = e.currentTarget.dataset.matchTeams;
                deleteMatchEntry(matchId, matchTeams);
            });
        });
    }

    // --- 10. Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        // Modal Create Listeners
        if (openBtn) { openBtn.addEventListener('click', showFixtureModal); }
        if (openBtnEmpty) { openBtnEmpty.addEventListener('click', showFixtureModal); }
        if (closeBtn) { closeBtn.addEventListener('click', hideFixtureModal); }
        if (cancelBtn) { cancelBtn.addEventListener('click', hideFixtureModal); }
        if (modal) { modal.addEventListener('click', (e) => { if (e.target === modal) hideFixtureModal(); }); }

        // Form Submit Listener (Create)
        if (form && submitBtn) {
            form.addEventListener("submit", function(e) { e.preventDefault(); addMatchEntry(form, submitBtn); });
        }

        // Modal Edit Listeners
        if (closeEditBtn) { closeEditBtn.addEventListener('click', hideEditFixtureModal); }
        if (cancelEditBtn) { cancelEditBtn.addEventListener('click', hideEditFixtureModal); }
        if (editModal) { editModal.addEventListener('click', (e) => { if (e.target === editModal) hideEditFixtureModal(); }); }
        
        // Form Submit Listener (Edit)
        if (editForm && editSubmitBtn) {
            editForm.addEventListener("submit", function(e) { 
                e.preventDefault(); 
                const matchId = document.getElementById('edit-match-id').value;
                updateMatchEntry(editForm, editSubmitBtn, matchId); 
            });
        }

        // Filter Listener
        if (categoryFilterSelect) {
            categoryFilterSelect.addEventListener('change', filterAndDisplayMatches);
        }

        // Listener untuk Refresh data setelah Create/Update/Delete
        document.addEventListener('matchAdded', function() {
            fetchMatchesFromServer();
        });

        // Initial data fetch
        fetchMatchesFromServer();
    });
</script>
{% endblock %}