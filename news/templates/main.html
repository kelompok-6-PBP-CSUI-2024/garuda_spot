{% extends 'base.html' %}
{% load static %}

{% block content %}
<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">Loading news…</p>
</div>

<div id="error" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-red-600">Failed to load news.</p>
</div>

<div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">No news yet.</p>
</div>

<div id="grid" style="display:none"></div>

<script>
  const NEWS_API_ENDPOINT = "{% url 'news:show_json' %}";

  // DOM
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const newsGridContainer = document.getElementById('grid');

  function setVis(el, show) { if (el) el.style.display = show ? '' : 'none'; }

  function displayPageSection({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
    setVis(loadingSpinner, showLoading);
    setVis(errorMessage, showError);
    setVis(emptyStateDisplay, showEmpty);
    setVis(newsGridContainer, showGrid);
    if (showGrid && newsGridContainer) {
      newsGridContainer.className = 'grid grid-cols-1 gap-6';
    }
  }

  function buildNewsCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200 overflow-hidden';
    const linkDetail = `{% url 'news:show_news' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const wrapper = document.createElement('div');
    wrapper.className = 'p-5';

    const meta = document.createElement('div');
    meta.className = 'text-sm text-gray-500 mb-2';
    const cat = document.createElement('span');
    cat.className = 'px-2 py-0.5 rounded-md bg-red-50 text-red-700 border border-red-200';
    cat.textContent = item.category || 'General';
    const dot = document.createElement('span'); dot.className = 'mx-2'; dot.textContent = '•';
    const time = document.createElement('time'); time.textContent = item.publish_date || '';
    meta.append(cat, dot, time);

    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-gray-900 mb-3 leading-tight';
    const a = document.createElement('a');
    a.href = linkDetail;
    a.className = 'hover:text-red-600 transition-colors';
    a.textContent = item.title || '(untitled)';
    h3.appendChild(a);

    const p = document.createElement('p');
    p.className = 'text-gray-600 text-sm leading-relaxed mb-4';
    const txt = item.content || '';
    p.textContent = txt.length > 200 ? txt.slice(0, 200) + '…' : txt;

    const footer = document.createElement('div');
    footer.className = 'pt-3 border-t border-gray-100 flex items-center justify-between';
    const readMore = document.createElement('a');
    readMore.href = linkDetail;
    readMore.className = 'text-red-600 hover:text-red-700 font-medium text-sm';
    readMore.textContent = 'Read more →';
    footer.appendChild(readMore);

    wrapper.append(meta, h3, p, footer);
    article.appendChild(wrapper);
    return article;
  }

  function renderAllNewsCards(items) {
    newsGridContainer.innerHTML = '';
    items.forEach(item => newsGridContainer.appendChild(buildNewsCardElement(item)));
  }

  async function fetchNewsFromServer() {
    try {
      displayPageSection({ showLoading: true });
      const res = await fetch(NEWS_API_ENDPOINT, { headers: { Accept: 'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const items = Array.isArray(data) ? data : [];
      if (items.length === 0) displayPageSection({ showEmpty: true });
      else { renderAllNewsCards(items); displayPageSection({ showGrid: true }); }
    } catch (e) {
      console.error('News fetch error:', e);
      displayPageSection({ showError: true });
    }
  }

  document.addEventListener('DOMContentLoaded', fetchNewsFromServer);
</script>
{% endblock %}