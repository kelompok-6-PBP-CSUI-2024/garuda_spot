{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="relative w-full select-none min-h-[20vh] sm:min-h-[22vh] md:min-h-[26vh] lg:min-h-[28vh] mb-8 ">
  <div
    class="absolute inset-0 -z-10 bg-center bg-cover"
    style="background-image:url('{% static "images/background.png" %}');">
  </div>
  <div class="absolute inset-0 -z-10 bg-gradient-to-b from-white/85 to-red-50/60"></div>

  <div class="relative z-10 h-full max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
    <div class="h-full flex flex-col items-center justify-center text-center py-6 sm:py-7">
      <p class="uppercase tracking-[0.35em] text-[10px] sm:text-xs text-gray-500 mb-2">Garuda Spot</p>
      <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight text-gray-900">BERITA TERKINI</h1>
      <div class="mx-auto mt-2 h-[3px] w-20 rounded-full bg-red-600"></div>
      <p class="mt-2 text-xs sm:text-sm text-gray-600">Berita terbaru sepak bola Indonesia</p>

      {% if request.user.is_authenticated and request.user.is_admin %}
      <button id="open-add-news"
              class="mt-4 inline-flex items-center justify-center px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500/50">
        Add News
      </button>
      {% endif %}
    </div>
  </div>
</section>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-3">
  <div class="flex items-center gap-3" id="news-filters-bar">

    <div class="relative inline-block" id="month-wrap">
      <button id="month-btn"
              class="inline-flex items-start justify-between gap-2 px-4 py-2.5 border-b-2 border-red-700 bg-white w-[200px]">
        <span id="month-label" class="flex-1 text-left whitespace-normal break-words leading-snug">
          Filter bulan: Semua
        </span>
        <svg class="w-4 h-4 shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.27a.75.75 0 01-.02-1.06z"/>
        </svg>
      </button>
      <div id="month-menu"
           class="hidden absolute z-10 mt-2 w-[200px] rounded-xl border border-gray-200 bg-white shadow-lg overflow-hidden">
        <ul class="py-1">
          <li><a data-month=""  href="#" class="block px-4 py-2 hover:bg-slate-50">Semua</a></li>
          <li><a data-month="1" href="#" class="block px-4 py-2 hover:bg-slate-50">Jan</a></li>
          <li><a data-month="2" href="#" class="block px-4 py-2 hover:bg-slate-50">Feb</a></li>
          <li><a data-month="3" href="#" class="block px-4 py-2 hover:bg-slate-50">Mar</a></li>
          <li><a data-month="4" href="#" class="block px-4 py-2 hover:bg-slate-50">Apr</a></li>
          <li><a data-month="5" href="#" class="block px-4 py-2 hover:bg-slate-50">Mei</a></li>
          <li><a data-month="6" href="#" class="block px-4 py-2 hover:bg-slate-50">Jun</a></li>
          <li><a data-month="7" href="#" class="block px-4 py-2 hover:bg-slate-50">Jul</a></li>
          <li><a data-month="8" href="#" class="block px-4 py-2 hover:bg-slate-50">Agu</a></li>
          <li><a data-month="9" href="#" class="block px-4 py-2 hover:bg-slate-50">Sep</a></li>
          <li><a data-month="10" href="#" class="block px-4 py-2 hover:bg-slate-50">Okt</a></li>
          <li><a data-month="11" href="#" class="block px-4 py-2 hover:bg-slate-50">Nov</a></li>
          <li><a data-month="12" href="#" class="block px-4 py-2 hover:bg-slate-50">Des</a></li>
        </ul>
      </div>
    </div>

    <div class="relative inline-block" id="sort-wrap">
      <button id="sort-btn"
              class="inline-flex items-start justify-between gap-2 px-4 py-2.5 border-b-2 border-red-700 bg-white w-64">
        <span id="sort-label" class="flex-1 text-left whitespace-normal break-words leading-snug">
          Urutkan: Terbaru
        </span>
        <svg class="w-4 h-4 shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.27a.75.75 0 01-.02-1.06z"/>
        </svg>
      </button>
      <div id="sort-menu"
           class="hidden absolute z-10 mt-2 w-64 rounded-xl border border-gray-200 bg-white shadow-lg overflow-hidden">
        <ul class="py-1">
          <li><a data-sort="desc" href="#" class="block px-4 py-2 hover:bg-slate-50">Terbaru</a></li>
          <li><a data-sort="asc"  href="#" class="block px-4 py-2 hover:bg-slate-50">Terlama</a></li>
        </ul>
      </div>
    </div>

  </div>
</div>


<!-- Loading/Error/Empty UNDER the filters -->
<div id="loading" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <p class="text-gray-600">Loading newsâ€¦</p>
</div>
<div id="error" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <p class="text-red-600">Failed to load news.</p>
</div>
<div id="empty" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
  <p class="text-gray-600">No news yet.</p>
</div>


<div id="grid" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 gap-6">

</div>

<div id="load-more-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center my-8 hidden">
  <button id="load-more-btn"
          class="inline-flex items-center justify-center px-6 py-3 rounded-md bg-red-600 text-white font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
    Load More
  </button>
</div>
{% if request.user.is_authenticated and request.user.is_admin %}
<div id="add-news-modal" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
  <div class="absolute inset-0 bg-black/50" data-close-modal></div>
  <div class="relative w-full sm:max-w-lg bg-white rounded-t-2xl sm:rounded-2xl shadow-xl p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">Add News</h3>
      <button class="text-gray-500 hover:text-gray-700" data-close-modal>&times;</button>
    </div>
    <form id="add-news-form" class="space-y-4">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium text-gray-700">Title</label>
        <input name="title" type="text" required
               class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600"/>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Category</label>
          <input name="category" type="text" required
                 class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Publish date</label>
          <input name="publish_date" type="text" placeholder="e.g. 12 Oct 2025"
                 class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600"/>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Content</label>
        <textarea name="content" rows="5" required
                  class="mt-1 w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600"></textarea>
      </div>
      <div class="flex items-center justify-between pt-2">
        <p id="add-news-error" class="text-sm text-red-600 hidden"></p>
        <div class="ml-auto space-x-2">
          <button type="button" data-close-modal class="px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
          <button id="add-news-submit" type="submit" class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700">Add News</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
  const NEWS_API_ENDPOINT = "{% url 'news:show_json' %}";
  const ADD_NEWS_ENDPOINT = "{% url 'news:add_news_entry_ajax' %}";
  const DELETE_URL_TEMPLATE = "{% url 'news:delete_news_ajax' '00000000-0000-0000-0000-000000000000' %}";
  const IS_ADMIN = {% if request.user.is_authenticated and request.user.is_admin %}true{% else %}false{% endif %};

  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const newsGridContainer = document.getElementById('grid');
  // const sentinel = document.getElementById('sentinel'); // <-- DIHAPUS

  // VARIABEL BARU UNTUK TOMBOL LOAD MORE
  const loadMoreContainer = document.getElementById('load-more-container');
  const loadMoreBtn = document.getElementById('load-more-btn');

  const modal = document.getElementById('add-news-modal');
  const openBtn = document.getElementById('open-add-news');
  const form = document.getElementById('add-news-form');
  const submitBtn = document.getElementById('add-news-submit');
  const errText = document.getElementById('add-news-error');

  let page = 1;
  const PAGE_SIZE = 10;
  let isLoading = false;
  let noMore = false;

  function setVis(el, show) { if (el) el.classList[show ? 'remove' : 'add']('hidden'); }
  function displayPageSection({ showLoading=false, showError=false, showEmpty=false, showGrid=true }) {
    setVis(loadingSpinner, showLoading);
    setVis(errorMessage, showError);
    setVis(emptyStateDisplay, showEmpty);
    newsGridContainer.style.display = showGrid ? '' : 'none';
  }
  function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
  }
  function openModal(){ if (modal){ modal.classList.remove('hidden'); modal.classList.add('flex'); } }
  function closeModal(){ if (modal){ modal.classList.add('hidden'); modal.classList.remove('flex'); errText?.classList.add('hidden'); errText.textContent=''; form?.reset(); } }

  function buildNewsCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200 overflow-hidden';
    const linkDetail = `{% url 'news:show_news' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const wrapper = document.createElement('div'); wrapper.className = 'p-5';
    const meta = document.createElement('div'); meta.className = 'text-sm text-gray-500 mb-2';
    const cat = document.createElement('span'); cat.className = 'px-2 py-0.5 rounded-md bg-red-50 text-red-700 border border-red-200';
    cat.textContent = item.category || 'General';
    const dot = document.createElement('span'); dot.className = 'mx-2'; dot.textContent = 'â€¢';
    const time = document.createElement('time'); time.textContent = item.publish_date || '';
    meta.append(cat, dot, time);

    const h3 = document.createElement('h3'); h3.className = 'text-lg font-semibold text-gray-900 mb-3 leading-tight';
    const a = document.createElement('a'); a.href = linkDetail; a.className = 'hover:text-red-600 transition-colors';
    a.textContent = item.title || '(untitled)'; h3.appendChild(a);

    const p = document.createElement('p'); p.className = 'text-gray-600 text-sm leading-relaxed mb-4';
    const txt = item.content || ''; p.textContent = txt.length > 200 ? txt.slice(0, 200) + 'â€¦' : txt;

    const footer = document.createElement('div'); footer.className = 'pt-3 border-t border-gray-100 flex items-center justify-between';
    const readMore = document.createElement('a'); readMore.href = linkDetail; readMore.className = 'text-red-600 hover:text-red-700 font-medium text-sm';
    readMore.textContent = 'Read more â†’'; footer.appendChild(readMore);

    if (IS_ADMIN) {
      const del = document.createElement('button');
      del.type = 'button';
      del.dataset.deleteId = item.id;
      del.className = 'px-2 py-1 text-sm rounded border border-red-300 text-red-700 hover:bg-red-50';
      del.textContent = 'Delete';
      footer.appendChild(del);
    }

    wrapper.append(meta, h3, p, footer);
    article.appendChild(wrapper);
    return article;
  }

  function appendNews(items) {
    items.forEach(item => newsGridContainer.appendChild(buildNewsCardElement(item)));
  }

  // --- Merch-style dropdown controls ---
  let filterMonth = "";     // "" = all
  let sortOrder   = "desc"; // "desc" (Terbaru) | "asc" (Terlama)

  const monthWrap  = document.getElementById('month-wrap');
  const sortWrap   = document.getElementById('sort-wrap');
  const monthBtn   = document.getElementById('month-btn');
  const sortBtn    = document.getElementById('sort-btn');
  const monthMenu  = document.getElementById('month-menu');
  const sortMenu   = document.getElementById('sort-menu');
  const monthLabel = document.getElementById('month-label');
  const sortLabel  = document.getElementById('sort-label');

  function highlightActive(menuEl, predicate){
    menuEl.querySelectorAll('a').forEach(a=>{
      const active = predicate(a);
      a.classList.toggle('bg-[#e11d2a]/10', active);
      a.classList.toggle('font-semibold', active);
    });
  }

  function refreshFilterLabels(){
    const monthNice = {
      "": "Semua","1":"Jan","2":"Feb","3":"Mar","4":"Apr","5":"Mei","6":"Jun",
      "7":"Jul","8":"Agu","9":"Sep","10":"Okt","11":"Nov","12":"Des"
    };
    monthLabel.textContent = `Filter bulan: ${monthNice[String(filterMonth)] || 'Semua'}`;
    sortLabel.textContent  = `Urutkan: ${sortOrder === 'asc' ? 'Terlama' : 'Terbaru'}`;

    highlightActive(monthMenu, a => (a.dataset.month ?? "") === String(filterMonth));
    highlightActive(sortMenu,  a => (a.dataset.sort  ?? "desc") === String(sortOrder));
  }

  monthBtn?.addEventListener('click', ()=> monthMenu.classList.toggle('hidden'));
  sortBtn?.addEventListener('click',  ()=>  sortMenu.classList.toggle('hidden'));
  document.addEventListener('click', (e)=>{
    if(!monthWrap.contains(e.target)) monthMenu.classList.add('hidden');
    if(!sortWrap.contains(e.target))  sortMenu.classList.add('hidden');
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ monthMenu.classList.add('hidden'); sortMenu.classList.add('hidden'); }
  });

  monthMenu?.addEventListener('click', async (e)=>{
    const a = e.target.closest('a[data-month]');
    if(!a) return;
    e.preventDefault();
    filterMonth = a.dataset.month || "";
    monthMenu.classList.add('hidden');
    refreshFilterLabels();
    // reload
    page = 1; noMore = false; newsGridContainer.innerHTML = '';
    await fetchPage(page);
  });

  sortMenu?.addEventListener('click', async (e)=>{
    const a = e.target.closest('a[data-sort]');
    if(!a) return;
    e.preventDefault();
    sortOrder = a.dataset.sort || "desc";
    sortMenu.classList.add('hidden');
    refreshFilterLabels();
    page = 1; noMore = false; newsGridContainer.innerHTML = '';
    await fetchPage(page);
  });

  refreshFilterLabels();


async function fetchPage(p) {
  isLoading = true;
  if (loadMoreBtn) { loadMoreBtn.disabled = true; loadMoreBtn.textContent = 'Loading...'; }

  const params = new URLSearchParams({
    page: String(p),
    page_size: String(PAGE_SIZE),
    sort: sortOrder,              // <--- NEW
  });
  if (filterMonth) params.set('month', filterMonth);

  try {
    if (p === 1) { displayPageSection({ showLoading:true, showGrid:false }); setVis(loadMoreContainer, false); }
    const res = await fetch(`${NEWS_API_ENDPOINT}?${params.toString()}`, {
      headers: { Accept: 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const { items, has_next } = await res.json();

    if (p === 1 && (!Array.isArray(items) || items.length === 0)) {
      displayPageSection({ showEmpty:true, showGrid:false });
      setVis(loadMoreContainer, false);
      noMore = true;
      return;
    }

    appendNews(items);
    displayPageSection({ showGrid:true });
    noMore = !has_next;
    setVis(loadMoreContainer, !noMore);
  } catch (e) {
    if (p === 1) displayPageSection({ showError:true, showGrid:false });
    setVis(loadMoreContainer, false);
    console.error(e);
  } finally {
    isLoading = false;
    if (loadMoreBtn) { loadMoreBtn.disabled = false; loadMoreBtn.textContent = 'Load More'; }
  }
}


  if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', () => {
      if (!isLoading && !noMore) {
        page += 1;
        fetchPage(page);
      }
    });
  }

  if (openBtn && modal && form) {
    openBtn.addEventListener('click', openModal);
    document.querySelectorAll('[data-close-modal]').forEach(el => el.addEventListener('click', closeModal));
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errText.classList.add('hidden'); errText.textContent = '';
      submitBtn.disabled = true;
      try {
        const fd = new FormData(form);
        const res = await fetch(ADD_NEWS_ENDPOINT, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
          body: fd
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        closeModal();
        page = 1; noMore = false;
        newsGridContainer.innerHTML = '';
        setVis(loadMoreContainer, false);
        await fetchPage(page);
      } catch (err) {
        errText.textContent = err.message || 'Failed to create news';
        errText.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    });
  }

  newsGridContainer.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-delete-id]');
    if (!btn) return;
    const id = btn.dataset.deleteId;
    const url = DELETE_URL_TEMPLATE.replace('00000000-0000-0000-0000-000000000000', id);
    btn.disabled = true;
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') || '' },
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      btn.closest('article')?.remove();
      
      if (newsGridContainer.children.length === 0 && !noMore && !isLoading) {
        await fetchPage(page);
      }
      
      if (newsGridContainer.children.length === 0 && noMore) {
        displayPageSection({ showEmpty: true, showGrid: false });
        setVis(loadMoreContainer, false);
      }

    } catch {
      btn.disabled = false;
      alert('Delete failed');
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await fetchPage(page);
    // if (sentinel) observer.observe(sentinel); // <-- DIHAPUS
  });
</script>

{% endblock %}