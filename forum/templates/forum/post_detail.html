{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>{{ post.title }} · Garuda Spot</title>
{% endblock meta %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <div class="bg-white p-6 border-t border-b border-red-800">
    <div class="flex items-center justify-between mb-2 text-sm text-gray-500">
      <div>
        <span>{{ post.author_name|default:"Orang" }}</span>
        <span>•</span>
        <span>{{ post.created_at|date:'l, d F Y' }}</span>
      </div>
      <span class="text-red-500 font-medium">{{ post.category.name }}</span>
    </div>

    <h1 class="text-2xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

    <div class="prose max-w-none text-gray-700 leading-relaxed">
      {{ post.body|linebreaksbr }}
    </div>

    {% if request.user.is_authenticated and request.user.is_superuser %}
      <form action="{% url 'forum:delete_post' post.slug %}"
            method="POST"
            class="mb-4"
            style="margin-top:10px">
        {% csrf_token %}
        <button type="submit"
          class="text-red-600 text-sm hover:underline">
          Delete
        </button>
      </form>
    {% endif %}
  </div>
  

  <div class="mt-8">
  <h3 class="text-lg font-semibold text-gray-800 mb-4 px-4">Komentar</h3>
  <div id="comment-list" class="space-y-3">
    {% for c in comments %}
      {% include "forum/_comment.html" with c=c %}
    {% empty %}
      <p class="text-gray-500 text-sm no-comments">Belum ada komentar.</p>
    {% endfor %}
  </div>

    <form id="comment-form" class="mt-6 bg-white p-4 border-t border-red-400">
      <input type="text" name="author_name" placeholder="Nama (opsional)" class="w-full border border-gray-300 rounded-sm px-3 py-2 mb-3">
      <textarea name="body" rows="3" placeholder="Tulis komentar…" required class="w-full border border-gray-300 rounded-sm px-3 py-2 mb-3"></textarea>
      <button type="submit" class="bg-red-700 hover:bg-red-800 text-white font-medium px-4 py-2 rounded-sm">Send</button>
      <span id="cmsg" class="text-sm text-gray-500 ml-3"></span>
    </form>
  </div>
</div>


<script>
(function(){
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');
  const form = document.getElementById('comment-form');
  const list = document.getElementById('comment-list');
  const cmsg = document.getElementById('cmsg');

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    cmsg.textContent = 'Mengirim…';
    const formData = new FormData(form);
    fetch("{% url 'forum:comment_create' post.slug %}", {
      method:'POST',
      headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken},
      body: formData
    }).then(r=>r.json()).then(data=>{
      if(data.ok){
      const emptyMsg = list.querySelector('.no-comments');
      if (emptyMsg) {
        emptyMsg.remove();
      }
        list.insertAdjacentHTML('beforeend', data.html);
        form.reset();
        cmsg.textContent = 'Terkirim!';
        setTimeout(()=>cmsg.textContent='', 1200);
      }else{
        cmsg.textContent = 'Gagal: ' + JSON.stringify(data.errors);
      }
    }).catch(()=> cmsg.textContent='Gagal jaringan');
  });
})();
</script>
{% endblock %}
