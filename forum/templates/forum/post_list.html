{% extends 'base.html' %}
{% load static %}

{# 
   <head>
#}
{% block meta %}
  <style type="text/tailwindcss">
    .card {
      @apply border-t border-red-200 pt-6 pb-4 box-border overflow-visible min-w-0;
    }
    .meta {
      @apply text-sm text-gray-500 flex flex-wrap items-center gap-x-3;
    }
    .meta span:first-child {
      @apply font-bold text-gray-800; 
    }
    .title {
      @apply text-lg font-extrabold my-1.5 overflow-visible break-words text-gray-900;
    }
    .card p, .muted {
      @apply text-gray-500 whitespace-normal overflow-visible break-words max-w-full;
    }
    .right-tag {
      @apply ml-auto text-red-500 static shadow-lg;
    }
    .likebar {
      @apply flex items-center gap-2 mt-2;
    }
    .btn-like {
      @apply bg-transparent cursor-pointer leading-none transition duration-150 ease-in-out hover:scale-110;
    }
    .btn-like .heart {
      @apply text-xl text-gray-300;
    }
    .btn-like.liked .heart {
      @apply text-red-800;
    }
    .post-text {
      @apply whitespace-pre-wrap break-words max-w-full text-gray-600 mt-1.5;
    }
  </style>
{% endblock meta %}


{# 
  BLOCK INI BERISI SEMUA KONTEN HALAMAN ANDA 
#}
{% block content %}
<div id="forum-wrapper" class="font-sans h-full" data-initial-page="{% if page_obj %}{{ page_obj.number }}{% else %}1{% endif %}" data-has-next="{% if page_obj and page_obj.has_next %}true{% else %}false{% endif %}">
  
  <div class="wrap max-w-6xl mx-auto px-4 h-full grid grid-cols-1 md:grid-cols-[200px_1fr] gap-6">
    
    <aside class="bg-red-900 text-white flex flex-col items-start px-4 py-4 h-fit sticky top-20 rounded-lg">

      <h3 class="tracking-wider mb-4 font-extrabold text-center border-l-2 py-1 px-2 border-white text-lg">FORUM</h3>
      <nav class="flex flex-col space-y-1 w-full">
        <a href="#" data-cat="all" class="js-cat block text-white py-2 px-3 opacity-90 text-center hover:opacity-100 hover:bg-red-800 rounded
          {% if active_category == 'all' %}font-bold underline bg-red-800/50{% endif %}"> 
          Semua 
        </a>
        {% for c in categories %}
          <a href="#" data-cat="{{ c.slug }}" class="js-cat block text-white py-2 px-3 opacity-90 text-center hover:opacity-100 hover:bg-red-800 rounded
            {% if active_category == c.slug %}font-bold underline bg-red-800/50{% endif %}">
            {{ c.name }}
          </a>
        {% endfor %}
        </nav>
    </aside>

    <main class="content min-w-0">
      
      <div class="toolbar flex flex-col sm:flex-row gap-3 items-center justify-between mb-4">
        <div class="muted text-sm shrink-0">Garuda Spot - {{ year }}</div>
        <form id="search-form" class="w-full sm:w-auto">
          <input type="search" name="q" id="q" placeholder="Cari topik…" value="{{ form.q.value|default:'' }}"
                 class="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-500">
          <input type="hidden" name="category" id="category" value="{{ active_category }}">
        </form>
      </div>

      <form id="post-create-form" class="bg-white border border-gray-200 rounded-xl p-4 mb-4 shadow-sm space-y-3">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Judul" required
               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500">
        <input type="text" name="author_name" placeholder="Penulis (opsional)"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500">
        <select name="category" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500">
          <option value="">-- Pilih Kategori --</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if active_category == c.slug %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <textarea name="body" rows="4" placeholder="Tulis isi post…" required
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
        
        <div class="flex justify-between items-center pt-2">
           <button type="submit" class="border border-transparent rounded-lg px-4 py-2 bg-red-700 text-white cursor-pointer hover:bg-red-800 font-semibold transition-colors">
             Send
           </button>
           <span id="post-create-msg" class="muted text-sm"></span>
        </div>
      </form>

      <div id="post-list" class="bg-white rounded-lg border border-gray-200 shadow-sm px-4">
        {% for p in posts %}
          {% include "forum/_post_card.html" with p=p liked_ids=liked_ids %}
        {% empty %}
          <p class="muted p-6 text-center">Belum ada posting.</p>
        {% endfor %}
      </div>

      <button id="load-more" 
              class="loadmore block my-5 mx-auto border border-gray-300 px-4 py-2 rounded-lg bg-white cursor-pointer hover:bg-gray-50 font-medium text-gray-700"
              {% if not page_obj or not page_obj.has_next %}hidden{% endif %}>
        Load More
      </button>
    </main>
  </div> 
</div> 
{% endblock content %}

{# 
  BLOCK INI MENAMBAHKAN JAVASCRIPT KE HALAMAN
#}
{% block body_end %}
  <script>
  (function(){
    function getCookie(name){
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }
    const csrftoken = getCookie('csrftoken'); 

    const listEl = document.getElementById('post-list');
    const loadBtn = document.getElementById('load-more');
    const qEl = document.getElementById('q');
    const catInput = document.getElementById('category');
    const postForm = document.getElementById('post-create-form');
    const postMsg = document.getElementById('post-create-msg');
    const wrapper = document.getElementById('forum-wrapper'); 
    const initialPageAttr = wrapper.getAttribute('data-initial-page');
    let page = parseInt(initialPageAttr || '1', 10);

    function fetchList(opts={}){
      const params = new URLSearchParams({
        page: opts.page || 1,
        q: qEl.value || '',
        category: catInput.value || 'all'
      });
      const url = "{% url 'forum:post_list_partial' %}?" + params.toString();
      return fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(r => r.json());
    }
    
    function render(html, append=false){
      if (!append) {
          if (!html.trim()) {
              listEl.innerHTML = '<p class="muted p-6 text-center">Tidak ada posting yang cocok.</p>';
          } else {
              listEl.innerHTML = html;
          }
      } else { 
          const emptyMsg = listEl.querySelector('.muted');
          if (emptyMsg) emptyMsg.remove();
          
          if (opts.prepend) {
            listEl.insertAdjacentHTML('afterbegin', html);
          } else {
            listEl.insertAdjacentHTML('beforeend', html);
          }
      }
    }

    function renderPosts(html, mode = 'replace') {
        const emptyMsg = listEl.querySelector('.muted');
        if (emptyMsg) emptyMsg.remove();

        if (mode === 'replace') {
            if (!html.trim()) {
                listEl.innerHTML = '<p class="muted p-6 text-center">Tidak ada posting yang cocok.</p>';
            } else {
                listEl.innerHTML = html;
            }
        } else if (mode === 'append') {
            listEl.insertAdjacentHTML('beforeend', html);
        } else if (mode === 'prepend') {
            listEl.insertAdjacentHTML('afterbegin', html);
        }
    }

    
    function updateLoadMore(show){ loadBtn.hidden = !show; }

    listEl.addEventListener('click', function(e){
      const btn = e.target.closest('.btn-like');
      if (!btn) return;
      const card = btn.closest('.card');
      const slug = card?.dataset?.slug;
      if (!slug) return;
      fetch(`{% url 'forum:post_like' 'SLUG_PLACEHOLDER' %}`.replace('SLUG_PLACEHOLDER', slug), {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
      })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) return;
        const countEl = card.querySelector('.like-count');
        if (countEl) countEl.textContent = data.like_count;
        if (data.liked) btn.classList.add('liked');
        else btn.classList.remove('liked');
      })
      .catch(() => {});
    });

    postForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      postMsg.textContent = 'Mengirim…';
      const formData = new FormData(postForm);
      
      fetch("{% url 'forum:post_create' %}", {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest'}, 
        body: formData
      }).then(r=>r.json())
        .then(data=>{
          if(data.ok && data.html){
            renderPosts(data.html, 'prepend');
            postForm.reset();
            postMsg.textContent = 'Terkirim!';
            setTimeout(()=>postMsg.textContent='', 1200);
          }else{
            postMsg.textContent = 'Gagal: ' + (data.errors ? JSON.stringify(data.errors) : 'Error');
          }
        }).catch(()=> postMsg.textContent = 'Gagal jaringan');
    });

    document.querySelectorAll('.js-cat').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.js-cat').forEach(x => {
            x.classList.remove('font-bold', 'underline', 'bg-red-800/50');
        });
        a.classList.add('font-bold', 'underline', 'bg-red-800/50');
        
        catInput.value = a.dataset.cat;
        page = 1;
        fetchList({page}).then(({html, has_next}) => {
          renderPosts(html, 'replace'); 
          updateLoadMore(Boolean(has_next));
          history.replaceState(null, '', `?category=${catInput.value}&q=${encodeURIComponent(qEl.value)}`);
        });
      });
    });

    let t;
    qEl.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        page = 1;
        fetchList({page}).then(({html, has_next}) => {
          renderPosts(html, 'replace');
          updateLoadMore(Boolean(has_next));
          history.replaceState(null, '', `?category=${catInput.value}&q=${encodeURIComponent(qEl.value)}`);
        });
      }, 320);
    });

    loadBtn.addEventListener('click', ()=>{
      page += 1;
      loadBtn.disabled = true;
      loadBtn.textContent = 'Memuat...';
      fetchList({page}).then(({html, has_next}) => {
        renderPosts(html, 'append');
        updateLoadMore(Boolean(has_next));
      }).catch(()=>{ 
        page -= 1; 
      }).finally(() => {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Muat lebih banyak';
      });
    });
    updateLoadMore(wrapper.getAttribute('data-has-next') === 'true');
    
  })();
  </script>
{% endblock body_end %}