{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="flex items-center justify-between mb-4">
  <div>
    {% if request.user.is_authenticated %}
      <button id="btn-open-create" class="inline-block px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
        Create Ticket
      </button>
    {% endif %}
  </div>

  <div>
    {% if request.user.is_authenticated %}
      <form method="post" action="{% url 'accounts:logout' %}" class="inline">
        {% csrf_token %}
        <button type="submit"
                class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700">
          Logout {{ request.user.username }}
        </button>
      </form>
    {% else %}
      <a href="{% url 'accounts:login' %}"
         class="px-3 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
        Login
      </a>
      <a href="{% url 'accounts:register' %}"
         class="ml-2 px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700">
        Register
      </a>
    {% endif %}
  </div>
  </div>

<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">Loading tickets...</p>
  </div>

<div id="error" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-red-600">Failed to load tickets.</p>
  </div>

<div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">No tickets yet.</p>
  </div>

<div id="grid" style="display:none"></div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
  <div class="bg-white w-full max-w-lg rounded shadow-lg p-4">
    <div id="modal-body"></div>
  </div>
  
</div>

<script>
  const TICKETS_API_ENDPOINT = "{% url 'ticket:show_json' %}";
  const FORM_MATCH_URL = "{% url 'ticket:form_match' %}";
  const IS_AUTH = {{ request.user.is_authenticated|yesno:'true,false' }};

  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const grid = document.getElementById('grid');

  function setVis(el, show) { if (el) el.style.display = show ? '' : 'none'; }

  function displaySections({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
    setVis(loadingSpinner, showLoading);
    setVis(errorMessage, showError);
    setVis(emptyStateDisplay, showEmpty);
    setVis(grid, showGrid);
    if (showGrid && grid) grid.className = 'grid grid-cols-1 gap-6';
  }

  function buildMatchCard(item) {
    const el = document.createElement('article');
    el.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200 overflow-hidden';

    const wrapper = document.createElement('div');
    wrapper.className = 'p-5';

    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-gray-900 mb-2';
    h3.textContent = `${item.team1 || ''} vs ${item.team2 || ''}`;

    const p = document.createElement('p');
    p.className = 'text-gray-600 text-sm mb-2';
    p.textContent = item.date || '';

    const btnRow = document.createElement('div');
    btnRow.className = 'mb-3 flex gap-2';
    if (IS_AUTH) {
      const btnEdit = document.createElement('button');
      btnEdit.className = 'px-2 py-1 text-sm rounded border';
      btnEdit.textContent = 'Edit Match';
      btnEdit.addEventListener('click', () => openModalWith(`{% url 'ticket:form_match_edit' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.uuid)));

      const btnAddLink = document.createElement('button');
      btnAddLink.className = 'px-2 py-1 text-sm rounded border';
      btnAddLink.textContent = 'Add Link';
      btnAddLink.addEventListener('click', () => openModalWith(`{% url 'ticket:form_link' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.uuid)));

      const btnDelete = document.createElement('button');
      btnDelete.className = 'px-2 py-1 text-sm rounded border border-red-300 text-red-700';
      btnDelete.textContent = 'Delete';
      btnDelete.addEventListener('click', async () => {
        const url = `{% url 'ticket:delete_ticket' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.uuid);
        await fetch(url, { method: 'POST' }).catch(() => {});
        await fetchTickets();
      });

      btnRow.append(btnEdit, btnAddLink, btnDelete);
    }

    const links = document.createElement('div');
    links.className = 'text-sm text-gray-700';
    (item.links || []).forEach(l => {
      const a = document.createElement('a');
      a.href = l.vendor_link;
      a.className = 'block text-red-600 hover:text-red-700';
      a.textContent = `${l.vendor} - ${l.price}`;
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between';
      row.appendChild(a);
      if (IS_AUTH) {
        const del = document.createElement('button');
        del.className = 'ml-2 text-xs text-red-700 border border-red-300 rounded px-2 py-0.5';
        del.textContent = 'Delete';
        del.addEventListener('click', async (e) => {
          e.preventDefault();
          const url = `{% url 'ticket:delete_link' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', l.uuid);
          await fetch(url, { method: 'POST' }).catch(() => {});
          await fetchTickets();
        });
        row.appendChild(del);
      }
      links.appendChild(row);
    });

    wrapper.append(h3, p, btnRow, links);
    el.appendChild(wrapper);
    return el;
  }

  function render(items) {
    grid.innerHTML = '';
    items.forEach(it => grid.appendChild(buildMatchCard(it)));
  }

  async function fetchTickets() {
    try {
      displaySections({ showLoading: true });
      const res = await fetch(TICKETS_API_ENDPOINT, { headers: { Accept: 'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const items = Array.isArray(data) ? data : [];
      if (items.length === 0) displaySections({ showEmpty: true });
      else { render(items); displaySections({ showGrid: true }); }
    } catch (e) {
      console.error('Ticket fetch error:', e);
      displaySections({ showError: true });
    }
  }

  document.addEventListener('DOMContentLoaded', fetchTickets);

  // Modal helpers
  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modal-body');

  function closeModal() { modal.classList.add('hidden'); modalBody.innerHTML = ''; }
  function wireCloseButtons() {
    modalBody.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', closeModal));
  }

  async function openModalWith(url) {
    try {
      const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      const html = await res.text();
      modalBody.innerHTML = html;
      modal.classList.remove('hidden');
      wireCloseButtons();
      // intercept form submit
      const form = modalBody.querySelector('form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          const res2 = await fetch(form.action, { method: 'POST', body: formData });
          if (res2.ok) { closeModal(); await fetchTickets(); }
        });
      }
    } catch {}
  }

  const btnOpenCreate = document.getElementById('btn-open-create');
  if (btnOpenCreate) btnOpenCreate.addEventListener('click', () => openModalWith(FORM_MATCH_URL));
  </script>
{% endblock %}

