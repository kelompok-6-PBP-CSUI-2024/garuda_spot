{% extends 'base.html' %}
{% load static %}

{% block content %}
      <h1 class="text-3xl font-bold text-gray-900 mb-2 sm:px-2 lg:px-1">
        &nbsp
      </h1>
      <h1 class="text-3xl font-bold text-gray-900 mb-2 sm:px-2 lg:px-1">
        Browsing Dan Pembelian Tiket
      </h1>
<div class="flex items-center justify-between mb-4 sm:px-2 lg:px-1">
  <div class="flex items-center gap-2">
    {% if user.is_authenticated and user.is_superuser %}
      <button id="btn-open-create" class="px-4 py-2 rounded bg-[#e11d2a] hover:bg-[#b91c1c] text-white ml-px">Create Ticket</button>
    {% elif user.is_authenticated and user.is_admin %}
      <button id="btn-open-create" class="px-4 py-2 rounded bg-[#e11d2a] hover:bg-[#b91c1c] text-white ml-px">Create Ticket</button>
    {% endif %}
  </div>
  <div class="relative inline-block mr-px" id="sort-wrap">
    <button id="sort-btn"
            class="inline-flex items-start justify-between gap-2 px-4 py-2.5 border-b-2 border-red-700 bg-white w-[200px]">
      <span id="sort-label" class="flex-1 text-left whitespace-normal break-words leading-snug">Date: Newest</span>
      <svg class="w-4 h-4 shrink-0 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.25 8.27a.75.75 0 01-.02-1.06z"/></svg>
    </button>
    <div id="sort-menu"
         class="hidden absolute z-10 mt-2 w-[200px] rounded-xl border border-gray-200 bg-white shadow-lg overflow-hidden">
      <ul class="py-1">
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="date_desc" data-label="Date: Newest">Date: Newest</button></li>
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="date_asc"  data-label="Date: Oldest">Date: Oldest</button></li>
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="id_desc"    data-label="ID: High to Low">ID: High to Low</button></li>
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="id_asc"     data-label="ID: Low to High">ID: Low to High</button></li>
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="uuid_desc"  data-label="UUID: Z-A">UUID: Z-A</button></li>
        <li><button type="button" class="block w-full text-left px-4 py-2 hover:bg-slate-50" data-sort="uuid_asc"   data-label="UUID: A-Z">UUID: A-Z</button></li>
      </ul>
    </div>
  </div>
</div>

<div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">Loading tickets...</p>
  </div>

<div id="error" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-red-600">Failed to load tickets.</p>
  </div>

<div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center" style="display:none">
  <p class="text-gray-600">No tickets yet.</p>
  </div>

<div id="grid" style="display:none" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center" style="overflow-y:auto; z-index:50;">
  <div class="bg-white w-full max-w-lg rounded shadow-lg p-4" style="max-height:90vh; overflow-y:auto;">
    <div id="modal-body"></div>
  </div>
  <div id="modal-toast" class="hidden fixed top-6 right-6 z-50 px-4 py-2 rounded bg-red-600 text-white shadow-lg">
    <span id="modal-toast-text">Please fill all required fields.</span>
  </div>
  
</div>

<script>
  const TICKETS_API_ENDPOINT = "{% url 'tickets:show_json' %}";
  const FORM_MATCH_URL = "{% url 'tickets:form_match' %}";
  const CAN_MANAGE = {{ request.user.is_admin|yesno:"true,false" }} || {{ request.user.is_superuser|yesno:"true,false" }};

  // URL patterns for by-id and by-uuid variants
  const JSON_BY_ID_PATTERN = "{% url 'tickets:show_json_by_id' 0 %}";
  const XML_BY_ID_PATTERN = "{% url 'tickets:show_xml_by_id' 0 %}";
  const JSON_BY_UUID_PATTERN = "{% url 'tickets:show_json_by_uuid' '00000000-0000-0000-0000-000000000000' %}";
  const XML_BY_UUID_PATTERN = "{% url 'tickets:show_xml_by_uuid' '00000000-0000-0000-0000-000000000000' %}";
  const DETAIL_URL_PATTERN = "{% url 'tickets:detail' '00000000-0000-0000-0000-000000000000' %}";

  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const grid = document.getElementById('grid');

  function setVis(el, show) { if (el) el.style.display = show ? '' : 'none'; }

  function displaySections({ showLoading=false, showError=false, showEmpty=false, showGrid=false }) {
    setVis(loadingSpinner, showLoading);
    setVis(errorMessage, showError);
    setVis(emptyStateDisplay, showEmpty);
    setVis(grid, showGrid);
  }

  function buildMatchCard(item) {
    const el = document.createElement('article');
    el.className = 'relative bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow duration-200 overflow-hidden';

    const wrapper = document.createElement('div');
    wrapper.className = 'p-5';

    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-gray-900 mb-2 flex items-center gap-2 cursor-pointer';
    const tWrap = document.createElement('div');
    tWrap.className = 'flex items-center gap-2 flex-wrap';
    const left = document.createElement('span'); left.className='inline-flex items-center gap-2';
    if (item.img_team1) { const i=document.createElement('img'); i.src=item.img_team1; i.alt=item.team1||''; i.className='w-6 h-6 rounded-full object-cover'; left.appendChild(i); }
    left.appendChild(document.createTextNode(item.team1 || ''));
    const vs = document.createElement('span'); vs.textContent='vs'; vs.className='text-gray-500';
    const right = document.createElement('span'); right.className='inline-flex items-center gap-2';
    right.appendChild(document.createTextNode(item.team2 || ''));
    if (item.img_team2) { const i2=document.createElement('img'); i2.src=item.img_team2; i2.alt=item.team2||''; i2.className='w-6 h-6 rounded-full object-cover'; right.appendChild(i2); }
    tWrap.append(left, vs, right);
    h3.appendChild(tWrap);
    h3.addEventListener('click', () => { window.location.href = DETAIL_URL_PATTERN.replace('00000000-0000-0000-0000-000000000000', item.match_id); });

    const p = document.createElement('p');
    p.className = 'text-gray-600 text-sm mb-2';
    p.textContent = item.date || '';

    if (item.img_cup) {
      const cup = document.createElement('img');
      cup.src = item.img_cup; cup.alt='Cup'; cup.className = 'absolute top-2 right-2 w-10 h-10 object-cover rounded-md shadow transition-opacity duration-200 group-hover:opacity-90';
      el.appendChild(cup);
    }

    const btnRow = document.createElement('div');
    btnRow.className = 'mb-3 flex gap-2';
    if (CAN_MANAGE) {
      const btnEdit = document.createElement('button');
      btnEdit.className = 'px-2 py-1 text-sm rounded border';
      btnEdit.textContent = 'Edit Match';
      btnEdit.addEventListener('click', () => openModalWith(`{% url 'tickets:form_match_edit' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.match_id)));

      const btnAddLink = document.createElement('button');
      btnAddLink.className = 'px-2 py-1 text-sm rounded border';
      btnAddLink.textContent = 'Add Link';
      btnAddLink.addEventListener('click', () => openModalWith(`{% url 'tickets:form_link' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.match_id)));

      const btnDelete = document.createElement('button');
      btnDelete.className = 'px-2 py-1 text-sm rounded border border-red-300 text-red-700';
      btnDelete.textContent = 'Delete';
      btnDelete.addEventListener('click', async () => {
        const url = `{% url 'tickets:delete_ticket' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.match_id);
        await fetch(url, { method: 'POST' }).catch(() => {});
        await fetchTickets();
      });

      btnRow.append(btnEdit, btnAddLink, btnDelete);
    }

    const links = document.createElement('div');
    links.className = 'text-sm text-gray-700';
    (item.links || []).forEach(l => {
      const a = document.createElement('a');
      a.href = l.vendor_link;
      a.className = 'block text-red-600 hover:text-red-700';
      a.textContent = `${l.vendor} - Rp${new Intl.NumberFormat('id-ID').format(Number(l.price||0))}`;
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between';
      row.appendChild(a);
      if (CAN_MANAGE) {
        const del = document.createElement('button');
        del.className = 'ml-2 text-xs text-red-700 border border-red-300 rounded px-2 py-0.5';
        del.textContent = 'Delete';
        del.addEventListener('click', async (e) => {
          e.preventDefault();
          const url = `{% url 'tickets:delete_link' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', l.link_id);
          await fetch(url, { method: 'POST' }).catch(() => {});
          await fetchTickets();
        });
        row.appendChild(del);
      }
      links.appendChild(row);
    });

    const quickLinks = document.createElement('div');
    quickLinks.className = 'mt-3 flex flex-wrap gap-2 text-xs';
    const aJsonId = document.createElement('a'); aJsonId.href = JSON_BY_ID_PATTERN.replace('0', item.id); aJsonId.target='_blank'; aJsonId.className='px-2 py-1 rounded border text-gray-700 hover:bg-gray-50'; aJsonId.textContent='JSON (id)';
    const aJsonUuid = document.createElement('a'); aJsonUuid.href = JSON_BY_UUID_PATTERN.replace('00000000-0000-0000-0000-000000000000', item.match_id); aJsonUuid.target='_blank'; aJsonUuid.className='px-2 py-1 rounded border text-gray-700 hover:bg-gray-50'; aJsonUuid.textContent='JSON (uuid)';
    const aXmlId = document.createElement('a'); aXmlId.href = XML_BY_ID_PATTERN.replace('0', item.id); aXmlId.target='_blank'; aXmlId.className='px-2 py-1 rounded border text-gray-700 hover:bg-gray-50'; aXmlId.textContent='XML (id)';
    const aXmlUuid = document.createElement('a'); aXmlUuid.href = XML_BY_UUID_PATTERN.replace('00000000-0000-0000-0000-000000000000', item.match_id); aXmlUuid.target='_blank'; aXmlUuid.className='px-2 py-1 rounded border text-gray-700 hover:bg-gray-50'; aXmlUuid.textContent='XML (uuid)';
    quickLinks.append(aJsonId, aJsonUuid, aXmlId, aXmlUuid);

    wrapper.append(h3, p, btnRow, links, quickLinks);
    el.appendChild(wrapper);
    return el;
  }

  function sortItems(items, key){
    const arr = [...items];
    const cmp = (a,b)=> (a<b?-1:(a>b?1:0));
    switch(key){
      case 'date_asc': return arr.sort((a,b)=>cmp(new Date(a.date), new Date(b.date)));
      case 'date_desc': return arr.sort((a,b)=>cmp(new Date(b.date), new Date(a.date)));
      case 'id_asc': return arr.sort((a,b)=>cmp(a.id, b.id));
      case 'id_desc': return arr.sort((a,b)=>cmp(b.id, a.id));
      case 'uuid_asc': return arr.sort((a,b)=>cmp(a.match_id, b.match_id));
      case 'uuid_desc': return arr.sort((a,b)=>cmp(b.match_id, a.match_id));
      default: return arr;
    }
  }

  let currentItems = [];
  let currentSort = 'date_desc';

  function render(items) {
    grid.innerHTML = '';
    const sorted = sortItems(items, currentSort);
    sorted.forEach(it => grid.appendChild(buildMatchCard(it)));
  }

  async function fetchTickets() {
    try {
      displaySections({ showLoading: true });
      const res = await fetch(TICKETS_API_ENDPOINT, { headers: { Accept: 'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      currentItems = Array.isArray(data) ? data : [];
      if (currentItems.length === 0) displaySections({ showEmpty: true });
      else { render(currentItems); displaySections({ showGrid: true }); }
    } catch (e) {
      console.error('Ticket fetch error:', e);
      displaySections({ showError: true });
    }
  }

  document.addEventListener('DOMContentLoaded', fetchTickets);

  // Modal helpers
  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modal-body');

  function closeModal() { modal.classList.add('hidden'); modalBody.innerHTML = ''; }
  function wireCloseButtons() {
    modalBody.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', closeModal));
  }

  async function openModalWith(url) {
    try {
      const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      const html = await res.text();
      modalBody.innerHTML = html;
      modal.classList.remove('hidden');
      wireCloseButtons();
      // intercept form submit
      const form = modalBody.querySelector('form');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          // client-side validation with toast
          const toast = document.getElementById('modal-toast');
          const toastText = document.getElementById('modal-toast-text');
          function showToast(msg){ if(toast && toastText){ toastText.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 2500); } }
          if (!form.checkValidity()) {
            form.reportValidity();
            showToast('Please fill all required fields.');
            return;
          }
          const formData = new FormData(form);
          const res2 = await fetch(form.action, { method: 'POST', body: formData });
          if (res2.ok) { closeModal(); await fetchTickets(); }
          else {
            let msg = 'Submission failed. Please try again.';
            try {
              const err = await res2.json();
              if (err.errors) msg = Object.entries(err.errors)
                .map(([k, v]) => `${k}: ${v.join(', ')}`)
                .join('; ');
            } catch {}
            showToast(msg);
          }

        });
      }
    } catch {}
  }

  const btnOpenCreate = document.getElementById('btn-open-create');
  if (btnOpenCreate) btnOpenCreate.addEventListener('click', () => openModalWith(FORM_MATCH_URL));

  // Sort dropdown behavior (merch-like)
  (function(){
    const wrap = document.getElementById('sort-wrap');
    const btn = document.getElementById('sort-btn');
    const menu = document.getElementById('sort-menu');
    const label = document.getElementById('sort-label');
    if (!wrap || !btn || !menu || !label) return;
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); });
    document.addEventListener('click', (e)=>{ if(!wrap.contains(e.target)) menu.classList.add('hidden'); });
    menu.querySelectorAll('[data-sort]').forEach(item=>{
      item.addEventListener('click', ()=>{
        currentSort = item.getAttribute('data-sort');
        const text = item.getAttribute('data-label') || item.textContent.trim();
        label.textContent = 'Sort by: ' + text;
        menu.classList.add('hidden');
        if (currentItems.length) render(currentItems);
      });
    });
  })();
  </script>
      <h1 class="text-3xl font-bold text-gray-900 mb-2 sm:px-2 lg:px-1">
        &nbsp
      </h1>
{% endblock %}
